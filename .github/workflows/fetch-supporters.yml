name: Fetch Buy Me a Coffee Supporters

on:
  schedule:
    - cron: '0 6 * * 0'
  workflow_dispatch:

jobs:
  fetch-supporters:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read 
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Fetch all supporters and members from Buy Me a Coffee API
        env:
          BUYMEACOFFEE_API_TOKEN: ${{ secrets.BUYMEACOFFEE_API_TOKEN }}
        run: |
          set -e

          # Helper to fetch all paginated results for a given endpoint
          fetch_all_pages() {
            local url=$1
            local page=1
            local all_data="[]"
            while :; do
              resp=$(curl -s -H "Authorization: Bearer $BUYMEACOFFEE_API_TOKEN" "${url}?page=${page}")
              page_data=$(echo "$resp" | jq '.data')
              if [ "$(echo "$page_data" | jq 'length')" -eq 0 ]; then
                break
              fi
              all_data=$(jq -s '.[0] + .[1]' <(echo "$all_data") <(echo "$page_data"))
              page=$((page + 1))
            done
            echo "$all_data"
          }

          # Fetch all one-time supporters
          one_time_supporters=$(fetch_all_pages "https://developers.buymeacoffee.com/api/v1/supporters")

          # Fetch all members (active and inactive)
          members=$(fetch_all_pages "https://developers.buymeacoffee.com/api/v1/subscriptions?status=all")

          # Normalize and merge both datasets
          merged=$(jq -n \
            --argjson one_time "$one_time_supporters" \
            --argjson members "$members" '
            {
              lastUpdated: (now | strftime("%Y-%m-%dT%H:%M:%SZ")),
              supporters: (
                ($one_time[] | {
                  name: .payer_name,
                  coffees: .support_coffees,
                  totalAmount: .support_coffee_price,
                  message: .support_note,
                  supportedAt: .created_on,
                  type: "one-time"
                }) +
                ($members[] | {
                  name: .payer_name,
                  coffees: .support_coffees,
                  totalAmount: .support_coffee_price,
                  message: .support_note,
                  supportedAt: .created_on,
                  type: "member"
                })
              )
            }
          ')

          # Deduplicate supporters by name and supportedAt (if needed)
          echo "$merged" | jq '
            .supporters |= unique_by(.name, .supportedAt)
          ' > src/js/main/utils/supporters.json

          echo "Supporters data updated successfully!"
          cat src/js/main/utils/supporters.json

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code src/js/main/utils/supporters.json || echo "changes=true" >> $GITHUB_OUTPUT
          
      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/js/main/utils/supporters.json
          git commit -m "Update supporters data - $(date '+%Y-%m-%d %H:%M:%S')"
          git push
